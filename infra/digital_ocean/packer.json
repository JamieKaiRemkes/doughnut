{
    "variables": {
      "version": "May2025",
      "image": "ubuntu-24-04-x64",
      "region": "sgp1",
      "size": "c-8",
      "do_token": "{{env `DIGITALOCEAN_API_TOKEN`}}",
      "lia_password": "{{env `LIA_PASSWORD`}}",
      "ssh_username": "root"
    },
    "builders": [{
      "type": "digitalocean",
      "api_token": "{{user `do_token`}}",
      "ssh_username": "{{user `ssh_username`}}",
      "image": "{{user `image`}}",
      "region": "{{user `region`}}",
      "size": "{{user `size`}}",
      "droplet_name": "lia-{{user `version`}}",
      "snapshot_name": "lia-{{user `version`}}-{{timestamp}}"
    }],
    "provisioners": [{
      "type": "shell",
      "inline": [
        "sleep 50",
        "dpkg-reconfigure -p critical dash",
        "# Add necessary repositories",
        "apt-get update -y && apt-get install -y gnupg ca-certificates software-properties-common apt-transport-https",
        "curl -fSsL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor | sudo tee /usr/share/keyrings/google-chrome.gpg > /dev/null",
        "echo deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main | sudo tee /etc/apt/sources.list.d/google-chrome.list",
        "wget -q https://packages.microsoft.com/keys/microsoft.asc -O- | gpg --dearmor | tee /etc/apt/trusted.gpg.d/microsoft.gpg",
        "add-apt-repository universe",
        "apt-get update -y && apt-get upgrade -y",
        "# Install XFCE desktop environment",
        "apt-get install -y xfce4 xfce4-goodies",
        "# Install RDP for remote access",
        "apt-get install -y xrdp",
        "adduser xrdp ssl-cert",
        "sed -i 's/crypt_level=high/crypt_level=low/g' /etc/xrdp/xrdp.ini",
        "# Configure XRDP to use XFCE",
        "echo 'xfce4-session' > /etc/xrdp/xsession",
        "# Configure XRDP for better performance",
        "sed -i 's/max_bpp=32/max_bpp=16/g' /etc/xrdp/xrdp.ini",
        "sed -i 's/xserverbpp=24/xserverbpp=16/g' /etc/xrdp/xrdp.ini",
        "# Install essential tools and dependencies",
        "apt-get update -y && apt-get upgrade -y && apt-get install -y zsh git git-core libfuse2 google-chrome-stable vim net-tools software-properties-common wget xauth xvfb git-extras git-secret unzip zip bash-completion xclip whois",
        "# Install Chrome",
        "apt-get install -y google-chrome-stable",
        "# Install Cypress dependencies",
        "apt-get install -y libgtk2.0-0t64 libgtk-3-0t64 libgbm-dev libnotify-dev libnss3 libxss1 libasound2t64 libxtst6 libatomic1 libatk-bridge2.0-0 libcups2 libdrm2 libgbm1",
        "# Install development tools",
        "apt-get install -y bat lsof git-extras git-secret zoxide fzf fasd",
        "# Install Cursor IDE with desktop entry",
        "wget -O cursor.AppImage 'https://downloads.cursor.com/production/0781e811de386a0c5bcb07ceb259df8ff8246a52/linux/x64/Cursor-0.49.6-x86_64.AppImage'",
        "chmod +x cursor.AppImage",
        "mkdir -p /opt/cursor",
        "mv cursor.AppImage /opt/cursor/cursor",
        "# Create a wrapper script for Cursor",
        "cat > /usr/local/bin/cursor << 'EOL'",
        "#!/bin/bash",
        "/opt/cursor/cursor --no-sandbox \"$@\"",
        "EOL",
        "chmod +x /usr/local/bin/cursor",
        "# Create desktop entry for Cursor",
        "cat > /usr/share/applications/cursor.desktop << 'EOL'",
        "[Desktop Entry]",
        "Name=Cursor IDE",
        "Comment=AI-first code editor",
        "Exec=/opt/cursor/cursor %U",
        "Terminal=false",
        "Type=Application",
        "Icon=/opt/cursor/cursor.png",
        "Categories=Development;IDE;",
        "StartupWMClass=Cursor",
        "EOL",
        "# Download icon for Cursor",
        "wget -O /opt/cursor/cursor.png 'https://cursor.sh/apple-touch-icon.png'",
        "# Install IntelliJ IDEA with desktop entry",
        "snap install intellij-idea-community --classic",
        "# Fix IntelliJ icon and launcher",
        "ln -s /snap/intellij-idea-community/current/bin/idea.sh /usr/local/bin/idea",
        "# Create IntelliJ desktop entry manually",
        "wget -O /usr/share/icons/hicolor/256x256/apps/intellij-idea.png 'https://resources.jetbrains.com/storage/products/intellij-idea/img/meta/intellij-idea_logo_300x300.png'",
        "cat > /usr/share/applications/intellij-idea.desktop << 'EOL'",
        "[Desktop Entry]",
        "Name=IntelliJ IDEA",
        "Comment=Intelligent Java IDE",
        "Exec=/usr/local/bin/idea %U",
        "Terminal=false",
        "Type=Application",
        "Icon=/usr/share/icons/hicolor/256x256/apps/intellij-idea.png",
        "Categories=Development;IDE;",
        "StartupWMClass=jetbrains-idea",
        "EOL",
        "# Install Nerd Fonts for terminal icons and emoji support",
        "mkdir -p /usr/share/fonts/nerd-fonts",
        "wget -O /tmp/FiraCode.zip https://github.com/ryanoasis/nerd-fonts/releases/download/v3.1.1/FiraCode.zip",
        "unzip /tmp/FiraCode.zip -d /usr/share/fonts/nerd-fonts",
        "fc-cache -fv",
        "# Install emoji font",
        "# Install terminal with proper font",
        "apt-get install -y fonts-firacode fonts-noto-color-emoji",
        "apt install -f -y",
        "export ENCRYPTED_LIA_PASSWORD=$(echo $LIA_PASSWORD | openssl passwd -6 -stdin) && useradd -m -d /home/lia -s /usr/bin/zsh -p $ENCRYPTED_LIA_PASSWORD lia",
        "usermod -aG sudo lia",
        "# Configure firewall",
        "ufw allow from 0.0.0.0/0 to any port 22",
        "ufw allow from 0.0.0.0/0 to any port 3389",
        "ufw enable",
        "# Install Nix package manager",
        "curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --determinate --no-confirm",
        "sudo -u lia mkdir -p /home/lia/.config/nix && sudo -u lia touch /home/lia/.config/nix/nix.conf",
        "sudo -u lia echo 'experimental-features = nix-command flakes' >> /home/lia/.config/nix/nix.conf",
        "# Clone doughnut github repository",
        "sudo -u lia git clone https://github.com/nerds-odd-e/doughnut.git /home/lia/doughnut",
        "# Setup zsh with zimfw for user",
        "sudo -u lia mkdir -p /home/lia/.zim",
        "sudo -u lia curl -fsSL https://raw.githubusercontent.com/zimfw/install/master/install.zsh | sudo -u lia zsh",
        "# Create .zshenv file with skip_global_compinit setting",
        "echo 'skip_global_compinit=1' > /home/lia/.zshenv",
        "chown lia:lia /home/lia/.zshenv",
        "# Set default directory to doughnut in .zshrc",
        "echo '# Set default directory to doughnut project' >> /home/lia/.zshrc",
        "echo 'if [[ $PWD == $HOME ]]; then' >> /home/lia/.zshrc",
        "echo '  cd /home/lia/doughnut' >> /home/lia/.zshrc",
        "echo 'fi' >> /home/lia/.zshrc",
        "chown lia:lia /home/lia/.zshrc",
        "# Create Desktop folder for the user",
        "sudo -u lia mkdir -p /home/lia/Desktop",
        "sudo -u lia cp /usr/share/applications/cursor.desktop /home/lia/Desktop/",
        "sudo -u lia cp /usr/share/applications/intellij-idea.desktop /home/lia/Desktop/",
        "sudo -u lia cp /usr/share/applications/google-chrome.desktop /home/lia/Desktop/",
        "chown -R lia:lia /home/lia/Desktop/",
        "sudo -u lia chmod +x /home/lia/Desktop/*.desktop",
        "chown -R lia:lia /home/lia/.config",
        "# Create .xsession file for XRDP with proper permissions",
        "echo 'xfce4-session' > /home/lia/.xsession",
        "chmod +x /home/lia/.xsession",
        "chown -R lia:lia /home/lia/.xsession",
        "# Configure XFCE for better remote experience",
        "sudo -u lia mkdir -p /home/lia/.config/xfce4/xfconf/xfce-perchannel-xml/",
        "sudo -u lia cat > /home/lia/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml << 'EOL'",
        "<?xml version=\"1.0\" encoding=\"UTF-8\"?>",
        "<channel name=\"xfwm4\" version=\"1.0\">",
        "  <property name=\"general\" type=\"empty\">",
        "    <property name=\"theme\" type=\"string\" value=\"Default\"/>",
        "    <property name=\"use_compositing\" type=\"bool\" value=\"false\"/>",
        "  </property>",
        "</channel>",
        "EOL",
        "# Configure XFCE Terminal for lia user",
        "sudo -u lia mkdir -p /home/lia/.config/xfce4/terminal",
        "sudo -u lia cat > /home/lia/.config/xfce4/terminal/terminalrc << 'EOL'",
        "[Configuration]",
        "FontName=FiraCode Nerd Font Mono 12",
        "MiscAlwaysShowTabs=FALSE",
        "MiscBell=FALSE",
        "MiscBellUrgent=FALSE",
        "MiscBordersDefault=TRUE",
        "MiscCursorBlinks=FALSE",
        "MiscCursorShape=TERMINAL_CURSOR_SHAPE_BLOCK",
        "MiscDefaultGeometry=80x24",
        "MiscInheritGeometry=FALSE",
        "MiscMenubarDefault=TRUE",
        "MiscMouseAutohide=FALSE",
        "MiscMouseWheelZoom=TRUE",
        "MiscToolbarDefault=FALSE",
        "MiscConfirmClose=TRUE",
        "MiscCycleTabs=TRUE",
        "MiscTabCloseButtons=TRUE",
        "MiscTabCloseMiddleClick=TRUE",
        "MiscTabPosition=GTK_POS_TOP",
        "MiscHighlightUrls=TRUE",
        "MiscMiddleClickOpensUri=FALSE",
        "MiscCopyOnSelect=FALSE",
        "MiscShowRelaunchDialog=TRUE",
        "MiscRewrapOnResize=TRUE",
        "MiscUseShiftArrowsToScroll=FALSE",
        "MiscSlimTabs=FALSE",
        "MiscNewTabAdjacent=FALSE",
        "EOL",
        "# Cleanup",
        "apt-get clean",
        "rm -rf /var/lib/apt/lists/*",
        "# Enable RDP",
        "systemctl enable xrdp"
      ],
      "environment_vars": [
        "DEBIAN_FRONTEND=noninteractive",
        "LIA_PASSWORD={{user `lia_password`}}"
      ]
    }]
  }
